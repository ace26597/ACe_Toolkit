# Data Persistence Guide - ACe_Toolkit

**Purpose:** Ensure all user data survives reboots and system restarts
**Last Updated:** January 13, 2026

---

## Overview

ACe_Toolkit stores data in several locations. All persistent data is protected from accidental deletion or git commits through proper .gitignore configuration.

---

## Data Storage Locations

### 1. Session Database (Primary Data)

**Location:** `/home/ace/dev/ACe_Toolkit/apps/api/mermaid.sqlite`

**Contains:**
- Session-based projects and charts
- Session notes
- Diagram editions with version history
- User authentication data (if enabled)

**Size:** Currently ~77 KB (grows with usage)

**Protected:** âœ… `.gitignore` includes `*.sqlite`

**Backup Recommended:** âœ… YES - Contains all user data

**Persistence:**
- âœ… Survives reboots
- âœ… Survives app restarts
- âœ… Survives git operations (not tracked)
- âš ï¸ NOT automatically backed up

**Database Configuration:**
```python
# apps/api/app/core/database.py
DATABASE_URL = "sqlite+aiosqlite:///./mermaid.sqlite"
```

**Note:** The `.env` file specifies `app.db`, but the code uses `mermaid.sqlite`. This is the actual database file in use.

---

### 2. Application Logs

**Location:** `/home/ace/dev/ACe_Toolkit/logs/`

**Files:**
- `backend-YYYYMMDD.log` - Backend API logs (daily rotation)
- `frontend-YYYYMMDD.log` - Frontend Next.js logs (daily rotation)
- `startup-YYYYMMDD.log` - Startup script logs (daily rotation)
- `backend.pid` - Backend process ID
- `frontend.pid` - Frontend process ID

**Protected:** âœ… `.gitignore` includes `logs/`, `*.log`, `*.pid`

**Persistence:**
- âœ… Survives reboots
- âœ… Log files accumulate over time
- ğŸ“… New log files created daily

**Cleanup:** Consider periodic cleanup of old logs to save space

**Example cleanup script:**
```bash
# Delete logs older than 30 days
find /home/ace/dev/ACe_Toolkit/logs -name "*.log" -mtime +30 -delete
```

---

### 3. Environment Configuration

**Location:** `/home/ace/dev/ACe_Toolkit/apps/api/.env`

**Contains:**
- Database connection string
- Secret keys (JWT, etc.)
- API keys (Anthropic Claude API)
- CORS allowed origins
- Token expiration settings

**Protected:** âœ… `.gitignore` includes `.env`

**âš ï¸ IMPORTANT - SECURITY:**
- Contains sensitive API keys
- Never commit to git
- Backup securely (encrypted)
- Rotate keys if exposed

**Current Config:**
- Domain: `ai.ultronsolar.in` added to CORS
- Database: SQLite (local)
- Authentication: JWT with refresh tokens

---

### 4. Node Modules & Virtual Environment

**Locations:**
- `/home/ace/dev/ACe_Toolkit/node_modules` (frontend dependencies)
- `/home/ace/dev/ACe_Toolkit/apps/web/node_modules` (frontend deps)
- `/home/ace/dev/ACe_Toolkit/apps/api/.venv` (Python virtual environment)

**Protected:** âœ… `.gitignore` includes `node_modules`, `.venv`

**Persistence:**
- âœ… Survives reboots
- ğŸ”„ Can be regenerated from package.json / requirements.txt
- ğŸ’¾ Takes up significant disk space (~500MB - 1GB)

**Regenerate if needed:**
```bash
# Frontend
cd apps/web
npm install

# Backend
cd apps/api
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

---

### 5. Build Artifacts

**Locations:**
- `/home/ace/dev/ACe_Toolkit/apps/web/.next` (Next.js build cache)
- `*.pyc`, `__pycache__` (Python bytecode)

**Protected:** âœ… `.gitignore` includes `.next`, `__pycache__`

**Persistence:**
- âœ… Survives reboots
- ğŸ”„ Can be regenerated by rebuilding
- ğŸš€ Speeds up startup (cached builds)

**Rebuild if needed:**
```bash
cd apps/web
npm run build
```

---

### 6. Cloudflare Tunnel Credentials

**Location:** `~/.cloudflared/`

**Files:**
- `cert.pem` - Cloudflare authentication certificate
- `<UUID>.json` - Tunnel credentials
- `config.yml` - Tunnel configuration

**Protected:** âœ… `.gitignore` includes `.cloudflared/`, `*.pem`

**âš ï¸ CRITICAL - NEVER DELETE:**
- Required for tunnel auto-start
- Contains authentication credentials
- Deleting requires re-running full setup

**Backup:** âœ… YES - Backup securely (encrypted)

**Persistence:**
- âœ… Survives reboots
- âœ… Enables auto-start without re-authentication
- ğŸ”’ Contains secrets (never commit to git)

---

## Complete .gitignore Protection

The following patterns are protected from git commits:

```gitignore
# Dependencies
node_modules
.venv
__pycache__

# Environment
.env
.DS_Store

# Build artifacts
.next
build
dist

# Logs
logs/
*.log
*.pid

# Databases
*.sqlite
*.db
app.db
mermaid.db
mermaid.sqlite
chroma/
qdrant/.env.local

# Cloudflare Tunnel Credentials
.cloudflared/
*.pem
*credentials.json
```

---

## Data Backup Recommendations

### Critical Data (MUST backup)

1. **Database:** `apps/api/mermaid.sqlite`
   - Contains all user content
   - Backup daily/weekly depending on usage

2. **Environment:** `apps/api/.env`
   - Contains API keys and secrets
   - Backup securely (encrypted)

3. **Cloudflare Credentials:** `~/.cloudflared/`
   - Required for tunnel functionality
   - Backup securely (encrypted)

### Backup Script Example

```bash
#!/bin/bash
# backup_critical_data.sh

BACKUP_DIR="/home/ace/backups/acetoolkit"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

# Backup database
cp /home/ace/dev/ACe_Toolkit/apps/api/mermaid.sqlite \
   "$BACKUP_DIR/mermaid_$DATE.sqlite"

# Backup .env (encrypted)
gpg -c /home/ace/dev/ACe_Toolkit/apps/api/.env \
    -o "$BACKUP_DIR/env_$DATE.env.gpg"

# Backup Cloudflare credentials (encrypted)
tar czf - ~/.cloudflared/ | \
    gpg -c -o "$BACKUP_DIR/cloudflared_$DATE.tar.gz.gpg"

# Delete backups older than 30 days
find "$BACKUP_DIR" -type f -mtime +30 -delete

echo "Backup completed: $DATE"
```

**Add to crontab for automatic backups:**
```bash
# Daily backup at 2 AM
0 2 * * * /home/ace/dev/ACe_Toolkit/infra/scripts/backup_critical_data.sh
```

---

## Reboot Behavior

**What survives reboots:**
- âœ… Database (mermaid.sqlite)
- âœ… Environment config (.env)
- âœ… Logs directory and files
- âœ… Node modules / Python venv
- âœ… Build cache (.next)
- âœ… Cloudflare tunnel credentials

**What auto-starts:**
- âœ… Cloudflare tunnel (systemd service)
- âœ… Backend FastAPI (crontab â†’ start_all.sh)
- âœ… Frontend Next.js (crontab â†’ start_all.sh)

**Startup Sequence:**
1. System boots
2. **Systemd starts cloudflared** (~5 seconds)
3. **Crontab waits 30 seconds** (ensures network ready)
4. **start_all.sh runs** (starts backend + frontend)
5. **Backend ready** (~5-10 seconds after script)
6. **Frontend ready** (~20-30 seconds after script - includes build)
7. **Total:** ~60 seconds from boot to fully operational

---

## Storage Space Monitoring

**Current usage (approximate):**
```bash
# Check actual usage
du -sh /home/ace/dev/ACe_Toolkit

# Breakdown
apps/api/.venv/          ~200 MB   (Python packages)
apps/web/node_modules/   ~500 MB   (Node packages)
apps/api/mermaid.sqlite  ~100 KB   (Database - grows)
apps/web/.next/          ~50 MB    (Build cache)
logs/                    ~10 MB    (Log files - grows)
```

**Cleanup if space is low:**
```bash
# Remove old logs (30+ days)
find logs/ -name "*.log" -mtime +30 -delete

# Rebuild node_modules (if needed)
rm -rf node_modules apps/web/node_modules
npm install

# Clear Next.js cache
cd apps/web
rm -rf .next
npm run build
```

---

## Database Migrations

**If you need to reset the database:**

âš ï¸ **WARNING:** This deletes ALL data!

```bash
cd /home/ace/dev/ACe_Toolkit/apps/api

# Backup first!
cp mermaid.sqlite mermaid_backup_$(date +%Y%m%d).sqlite

# Delete database
rm mermaid.sqlite

# Restart backend (recreates empty database)
cd /home/ace/dev/ACe_Toolkit
./infra/scripts/stop_all.sh
./infra/scripts/start_all.sh
```

**For migrations with data preservation:**
```bash
cd apps/api

# Create migration
alembic revision --autogenerate -m "description"

# Apply migration
alembic upgrade head
```

---

## Summary

**Data Location Matrix:**

| Data Type | Location | Survives Reboot | Git Protected | Backup Priority |
|-----------|----------|-----------------|---------------|-----------------|
| Database | `apps/api/mermaid.sqlite` | âœ… | âœ… | ğŸ”´ Critical |
| Environment | `apps/api/.env` | âœ… | âœ… | ğŸ”´ Critical |
| CF Credentials | `~/.cloudflared/` | âœ… | âœ… | ğŸ”´ Critical |
| Logs | `logs/` | âœ… | âœ… | ğŸŸ¡ Medium |
| Node Modules | `node_modules/` | âœ… | âœ… | ğŸŸ¢ Low (regenerable) |
| Venv | `.venv/` | âœ… | âœ… | ğŸŸ¢ Low (regenerable) |
| Build Cache | `.next/` | âœ… | âœ… | ğŸŸ¢ Low (regenerable) |

---

**Last Updated:** January 13, 2026
**Repository:** ACe_Toolkit
**Deployment:** Raspberry Pi (Local + Cloudflare)
